name: Workflow
on:
  push: 
    branches:
        - main

jobs:
  SCA:
    runs-on: ubuntu-24.04
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin  
    
    - name: Build Docker image
      run: docker build -t ghcr.io/${{ github.repository }}/my-app:${{ github.sha }} .

    - name: Scan Docker image with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with: 
        image-ref: 'ghcr.io/${{ github.repository }}/my-app:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy SARIF Report
      uses: github/codeql-action/upload-sarif@v2
      with: 
        sarif_file: 'trivy-results.sarif'
